<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Author lihongli,592658688@qq.com"><title>IOS Emoji 编码打印 · Coding的小学生</title><meta name="description" content="最新在研究下IOS的emoji。主要目的是想Android ,wphone,symbian都同步支持ios 的emoji。因此设及到图库及表情定义符。在已有的emoji表情库里目前已知道记录的就很800多个，IOS 5 中集成的有479个。而IOS6 又新增了300个左右。
IOS 5 内部显示EM"><meta name="keywords" content="Hexo,HTML,CSS,iOS,Max,lihongli"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/./images/logo.png" style="width:127px;"><h3 title=""><a href="/">Coding的小学生</a></h3><div class="description"><p>Coding的小学生</p></div></div></div><ul class="social-links"><li><a href="http://github.com/lihongli528628"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/about">关于</a></li><li><a href="/links">链接</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="/images/header.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>IOS Emoji 编码打印</a></h3></div><div class="post-content"><p>最新在研究下IOS的emoji。主要目的是想<a href="http://lib.csdn.net/base/15" title="undefined" target="_blank" rel="external">Android</a> ,wphone,symbian都同步支持ios 的emoji。因此设及到图库及表情定义符。在已有的emoji表情库里目前已知道记录的就很800多个，IOS<br> 5 中集成的有479个。而IOS6 又新增了300个左右。</p>
<p>IOS 5 内部显示EMOJI使用提UTF16 编码。</p>
<p>先来看一段代码：</p>
<a id="more"></a>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span>  </span></div><div class="line">  </div><div class="line"><span class="meta">#define MAKE_Q(x) @#x  </span></div><div class="line"><span class="meta">#define MAKE_EM(x,y) MAKE_Q(x##y)  </span></div><div class="line"><span class="meta">#define MAKE_EMOJI(x) MAKE_EM(\U000,x)  </span></div><div class="line"><span class="meta">#define EMOJI_METHOD(x,y) + (NSString *)x &#123; return MAKE_EMOJI(y); &#125; //method implementions at .m file  </span></div><div class="line"><span class="meta">#define EMOJI_HMETHOD(x) + (NSString *)x;   //method define at .h file  </span></div><div class="line"><span class="meta">#define EMOJI_CODE_TO_SYMBOL(x) ((((0x808080F0 | (x &amp; 0x3F000) &gt;&gt; 4) | (x &amp; 0xFC0) <span class="meta-string">&lt;&lt; 10) | (x &amp; 0x1C0000) &lt;&lt; 18) | (x &amp; 0x3F) &lt;&lt; 24); </span></span></div><div class="line">  </div><div class="line">@interface Emoji : NSObject  </div><div class="line">+ (NSString *)emojiWithCode:(int)code;  </div><div class="line">+ (NSArray *)allEmoji;  </div><div class="line">@end</div></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">#import "Emoji.h"  </div><div class="line">#import "EmojiEmoticons.h"  </div><div class="line">#import "EmojiMapSymbols.h"  </div><div class="line">#import "EmojiPictographs.h"  </div><div class="line">#import "EmojiTransport.h"  </div><div class="line">  </div><div class="line">@implementation Emoji  </div><div class="line">+ (NSString *)emojiWithCode:(int)code &#123;  </div><div class="line">    int sym = &lt;span style="color:#ff0000;"&gt;EMOJI_CODE_TO_SYMBOL&lt;/span&gt;(code);  </div><div class="line">    return [[NSString alloc] initWithBytes:&amp;sym length:sizeof(sym) encoding:NSUTF8StringEncoding];  </div><div class="line">&#125;  </div><div class="line">+ (NSArray *)allEmoji &#123;  </div><div class="line">    NSMutableArray *array = [NSMutableArray new];  </div><div class="line">    [array addObjectsFromArray:[EmojiEmoticons allEmoticons]];  </div><div class="line">    [array addObjectsFromArray:[EmojiMapSymbols allMapSymbols]];  </div><div class="line">    [array addObjectsFromArray:[EmojiPictographs allPictographs]];  </div><div class="line">    [array addObjectsFromArray:[EmojiTransport allTransport]];  </div><div class="line">      </div><div class="line">    return array;  </div><div class="line">&#125;  </div><div class="line">@end</div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span>  </span></div><div class="line"><span class="meta">#import <span class="meta-string">"Emoji.h"</span>  </span></div><div class="line">  </div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">EmojiEmoticons</span> : <span class="title">NSObject</span>  </span></div><div class="line">  </div><div class="line">+ (<span class="built_in">NSArray</span> *)allEmoticons;  </div><div class="line">  </div><div class="line">EMOJI_HMETHOD(grinningFace);</div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">"EmojiEmoticons.h"</span>  </span></div><div class="line">  </div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">EmojiEmoticons</span>  </span></div><div class="line">  </div><div class="line">+ (<span class="built_in">NSArray</span> *)allEmoticons &#123;  </div><div class="line">    <span class="built_in">NSMutableArray</span> *array = [<span class="built_in">NSMutableArray</span> new];  </div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0x1F600</span>; i&lt;=<span class="number">0x1F64F</span>; i++) &#123;  </div><div class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0x1F641</span> || i &gt; <span class="number">0x1F644</span>) &#123;  </div><div class="line">            [array addObject:[Emoji emojiWithCode:i]];  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">return</span> array;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">EMOJI_METHOD(grinningFace,<span class="number">1</span>F600);</div></pre></td></tr></table></figure>
<p>以上代码是我从网上DOWN的一位老外写的，这段代码其它是遍历将编码进行组合成数组。主要看的是</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#define EMOJI_CODE_TO_SYMBOL(x) ((((0x808080F0 | (x &amp; 0x3F000) &gt;&gt; 4) | (x &amp; 0xFC0) <span class="meta-string">&lt;&lt; 10) | (x &amp; 0x1C0000) &lt;&lt; 18) | (x &amp; 0x3F) &lt;&lt; 24);</span></span></div></pre></td></tr></table></figure>
<p>这个宏的作用。它实际上是将一个Uindoe码转为UTF8。其中灵活的运用了位运算，此算法我还没有推导出他的计算规律，估且放一边，后面我会讲到一些UTF8及大于0x10000的UNICODE码转UTF16等算法。这里先看看遍历出来后Emoji的效果图；</p>
<p><img src="http://img.my.csdn.net/uploads/201303/13/1363154094_9936.jpg" alt=""></p>
<p>呵呵，IOS的控件已帮我们自动的将UTF8或UTF16码进行转为相应的图片了，对IOS来说，图片资源就不用再让UCD出了或网上COPY了。</p>
<p>对于android ，wphone,symbian目前都没有很好的支持UNICODE 中的emoji。因此在做应用时需要各自的对照库及图片库。要完全兼容于IOS 6。哪务必要知道IOS 6中的各个emoji及其它表情符的编码定义，网上搜了好些都没有完整的编码定义及表情。没有办法，只硬着头皮上，把IOS6的全部导出来。话说干就干。<br>不过干之前先来了解一下基本知识（编码转换）。<br><img src="http://img.my.csdn.net/uploads/201303/13/1363154778_3494.jpg" alt=""><img src="http://img.my.csdn.net/uploads/201303/13/1363154796_4063.jpg" alt=""></p>
<p><img src="http://punchdrunker.github.com/iOSEmoji/table_html/cars/cars_07_01.png" alt=""><img src="http://punchdrunker.github.com/iOSEmoji/table_html/cars/cars_07_02.png" alt=""><img src="http://punchdrunker.github.com/iOSEmoji/table_html/cars/cars_07_03.png" alt="">        UnicodeU+1F1F7 U+1F1FAU+1F1EC U+1F1E7U+1F1E9 U+1F1EA        UTF80xF0 0x9F 0x87 0xB7 0xF0 0x9F 0x87 0xBA0xF0 0x9F 0x87 0xAC 0xF0 0x9F 0x87 0xA70xF0 0x9F 0x87 0xA9 0xF0 0x9F 0x87 0xAA        UTF160xD83C 0xDDF7 0xD83C 0xDDFA0xD83C 0xDDEC 0xD83C 0xDDE70xD83C 0xDDE9 0xD83C 0xDDEA        SB UnicodeE512E510E50E</p>
<p>###UTF-16 编码程序</p>
<p>假设要将 U+64321 (16进位) 转成 UTF-16 编码. 因为它超过 U+FFFF, 所以他必须编译成32位(4个byte)的格式,如下所示:11<br>    V  = 0x64321<br>    Vx = V - 0x10000<br>       = 0x54321<br>       = 0101 0100 0011 0010 0001</p>
<pre><code>Vh = 01 0101 0000 // Vx 的高位部份的 10 bits
Vl = 11 0010 0001 // Vx 的低位部份的 10 bits
w1 = 0xD800 //結果的前16位元初始值
w2 = 0xDC00 //結果的後16位元初始值

w1 = w1 | Vh
   = 1101 1000 0000 0000
   |        01 0101 0000
   = 1101 1001 0101 0000
   = 0xD950

w2 = w2 | Vl
   = 1101 1100 0000 0000
   |        11 0010 0001
   = 1101 1111 0010 0001
   = 0xDF21
</code></pre><p>所以这个字 U+64321 最后正确的 UTF-16 编码应该是:<br>    0xD950 0xDF21</p>
<p>而在小尾序中最后的编码应该是：<br>    0x50D9 0x21DF</p>
<p>按照这个算法，我们来推算一下U+1F604  利用推算来映射出位操作（位操作不是很熟的朋友可网上学习学习）。<br>0x1F604  =  0001 1111 0110 0000 0100 (二进制)<br>0x1F604 - 0x10000 = 0xF604 = 1111 0110 0000 0100</p>
<p>分别取0xF604 的高十位和低十位（不足的补0）</p>
<p>Vh =  00 0011 1101 = 0x3D  (高位)<br>Vl = 10 0000 0100 = 0x204 (低位)</p>
<p>然后取高位与前十六位初始元0xD800 进行或操作后为作UTF16的前部份<br>取低位与后十六位初始元0xDC00进行或操作后作为UTF16的后半部份。<br>0x3D | 0xD800 = 0xD83D<br>0x204 | 0xDC00 = 0xDE04<br>所以U+1F604 的UTF16 为0xD83D 0xDE04</p>
<p>假设要处理的UNICODE编码为X，来推一下位运算公式<br>第一步：X - 0x10000  得到结果为Y<br>第二步：取Y的高十位：Y &gt;&gt; 10   得到结果为Vh<br>第三步：取Y的低十位：Y  &amp; 3FF(11 1111 1111) 这样就可以把十位前的全部清零了。 得到结果为Vl<br>第四步：将高位与前16位初始元0xD800 进行或操作 Vh | 0xD800  得到前半部  记为Uf<br>第五步：将低位与后16位初始元0xDC00进行或操作Vl |0xDC00 得到后半部份。Ue<br>第六步：将前后两部份合在一起。先左移十六位 (Uf &lt;&lt; 16) 再或上Ue 即 (Uf &lt;&lt; 16) | Ue</p>
<p>把这个写为宏的形式：</p>
<p>#define UNICODETOUTF16(x)  ((Uf &lt;&lt; 16) | Ue) 将这个公式向前代替，最终得到</p>
<p>#define UNICODETOUTF16(x) (((((x - 0x10000) &gt;&gt;10) | 0xD800) &lt;&lt; 16)  | (((x-0x10000)&amp;3FF) | 0xDC00))         </p>
<p>同样使用UTF16转回为大于0x10000 的Unicode码；</p>
<p> #define MULITTHREEBYTEUTF16TOUNICODE(x,y) (((((x ^ 0xD800) &lt;&lt; 2) | ((y ^ 0xDC00) &gt;&gt; 8)) &lt;&lt; 8) | ((y ^ 0xDC00) &amp; 0xFF)) + 0x10000<br>当然这里还有大尾，小尾的区分，我这里就不再说明了，具体学习参考：<a href="http://zh.wikipedia.org/wiki/UTF-16" target="_blank" rel="external">http://zh.wikipedia.org/wiki/UTF-16</a></p>
<p>IOS 的提取代码：需实现UITextViewDelegate委托</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">BOOL</span>)textView:(<span class="built_in">UITextView</span> *)textView shouldChangeTextInRange:(<span class="built_in">NSRange</span>)range replacementText:(<span class="built_in">NSString</span> *)text  </div><div class="line">&#123;  </div><div class="line">    <span class="built_in">NSString</span> *hexstr = <span class="string">@""</span>;  </div><div class="line">  </div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; [text length];i++)  </div><div class="line">    &#123;  </div><div class="line">        hexstr = [hexstr stringByAppendingFormat:<span class="string">@"%@"</span>,[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"0x%1X "</span>,[text characterAtIndex:i]]];  </div><div class="line">    &#125;  </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"UTF16 [%@]"</span>,hexstr);  </div><div class="line">      </div><div class="line">    hexstr = <span class="string">@""</span>;  </div><div class="line">      </div><div class="line">    <span class="keyword">int</span> slen = strlen([text UTF8String]);  </div><div class="line">      </div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; slen; i++)   </div><div class="line">    &#123;  </div><div class="line">        <span class="comment">//fffffff0 去除前面六个F &amp; 0xFF   </span></div><div class="line">        hexstr = [hexstr stringByAppendingFormat:<span class="string">@"%@"</span>,[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"0x%X "</span>,[text UTF8String][i] &amp; <span class="number">0xFF</span> ]];  </div><div class="line">    &#125;  </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"UTF8 [%@]"</span>,hexstr);  </div><div class="line">      </div><div class="line">    hexstr = <span class="string">@""</span>;  </div><div class="line">      </div><div class="line">    <span class="keyword">if</span> ([text length] &gt;= <span class="number">2</span>) &#123;  </div><div class="line">          </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; [text length] / <span class="number">2</span> &amp;&amp; ([text length] % <span class="number">2</span> == <span class="number">0</span>) ; i++)   </div><div class="line">        &#123;  </div><div class="line">            <span class="comment">// three bytes  </span></div><div class="line">            <span class="keyword">if</span> (([text characterAtIndex:i*<span class="number">2</span>] &amp; <span class="number">0xFF00</span>) == <span class="number">0</span> ) &#123;  </div><div class="line">                hexstr = [hexstr stringByAppendingFormat:<span class="string">@"Ox%1X 0x%1X"</span>,[text characterAtIndex:i*<span class="number">2</span>],[text characterAtIndex:i*<span class="number">2</span>+<span class="number">1</span>]];  </div><div class="line">            &#125;  </div><div class="line">            <span class="keyword">else</span>  </div><div class="line">            &#123;<span class="comment">// four bytes    </span></div><div class="line">                hexstr = [hexstr stringByAppendingFormat:<span class="string">@"U+%1X "</span>,MULITTHREEBYTEUTF16TOUNICODE([text characterAtIndex:i*<span class="number">2</span>],[text characterAtIndex:i*<span class="number">2</span>+<span class="number">1</span>])];      </div><div class="line">            &#125;  </div><div class="line">              </div><div class="line">        &#125;  </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"(unicode) [%@]"</span>,hexstr);  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">else</span>  </div><div class="line">    &#123;  </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"(unicode) U+%1X"</span>,[text characterAtIndex:<span class="number">0</span>]);  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码搞好后在UITEXTVIEW中输入表情符，就会打印出相应的编码了。如果想进一步收集。只需要封装成自己想要的数据格式导出即可。</p>
<p>其中还有softbank的编码未搞懂，小日本的东西。</p>
<p><img src="http://img.my.csdn.net/uploads/201303/13/1363165007_4049.jpg" alt=""><br>参考：<br>UNICODE标准，查找<br><a href="http://www.unicode.org/" target="_blank" rel="external">http://www.unicode.org/</a><br><a href="http://www.unicode.org/charts/" target="_blank" rel="external">http://www.unicode.org/charts/</a></p>
<p>Emojin集合表（479）：<br><a href="http://punchdrunker.github.com/iOSEmoji/table_html/vehicle.html" target="_blank" rel="external">http://punchdrunker.github.com/iOSEmoji/table_html/vehicle.html</a></p>
<p>DEMO:<br><a href="https://github.com/lihongli528628/EmojiDemo.git" target="_blank" rel="external">https://github.com/lihongli528628/EmojiDemo.git</a></p>
<p><img src="http://punchdrunker.github.com/iOSEmoji/table_html/cars/cars_07_01.png" alt=""><img src="http://punchdrunker.github.com/iOSEmoji/table_html/cars/cars_07_02.png" alt=""><img src="http://punchdrunker.github.com/iOSEmoji/table_html/cars/cars_07_03.png" alt="">        UnicodeU+1F1F7 U+1F1FAU+1F1EC U+1F1E7U+1F1E9 U+1F1EA        UTF80xF0 0x9F 0x87 0xB7 0xF0 0x9F 0x87 0xBA0xF0 0x9F 0x87 0xAC 0xF0 0x9F 0x87 0xA70xF0 0x9F 0x87 0xA9 0xF0 0x9F 0x87 0xAA        UTF160xD83C 0xDDF7 0xD83C 0xDDFA0xD83C 0xDDEC 0xD83C 0xDDE70xD83C 0xDDE9 0xD83C 0xDDEA        SB UnicodeE512E510E50E</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-04-26</span><i class="fa fa-tag"></i><a href="/categories/技术/" title="技术" class="tag">技术 </a></div></div></div></div><div class="pagination"><ul class="clearfix"></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>